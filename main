#!/bin/bash
#PBS -l nodes=1:ppn=8,vmem=8gb,walltime=0:05:00
#PBS -N acpcART
#PBS -V

#TODO This app uses /N/u/brlife/git/acpcdetect locally installed. 

module load freesurfer
module load fsl

set -e

export ARTHOME=/N/u/brlife/git/acpcdetect
export input_t1=$(jq -r .t1 config.json)

cp $input_t1 .

if [ $(jq -r .reorient config.json) == true ]; then
	echo "running fslreorient2std"
	fslreorient2std t1.nii.gz t1.nii.gz
fi

gunzip t1.nii.gz

datatype=`mri_info t1.nii --type`
if [ $datatype != "uchar" ]; then
    echo "converting datatype to uchar"
    mri_convert -i t1.nii -odt uchar -o t1.nii
fi
echo "doing acpc alignment"
$ARTHOME/acpcdetect -v -i t1.nii -o t1.aligned.nii 

echo "converting datatype to float"
mri_convert -i t1.aligned.nii -odt float -o t1.nii

#echo "out data type:"
#mri_info t1.nii --type

gzip t1.nii

if [ $(jq -r .crop config.json) == true ]; then
	echo "cropping neck"
	robustfov -i t1.nii.gz -r t1.nii.gz
fi
		
